<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë ˆì‹œí”¼ ë§¤ë‹ˆì €</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: #f5f5f7;
      margin: 0;
      height: 100vh;
    }
    
    #app {
  display: flex;
  height: 100vh;
}

    .sidebar {
      width: 220px;
      background: white;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.05);
    }

    .sidebar button {
      background: #e5e5ea;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      cursor: pointer;
      font-size: 14px;
      text-align: left;
      transition: background 0.2s ease;
    }

    .sidebar button:hover {
      background: #d1d1d6;
    }

    .main {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
    }

    h1, h2, h3 {
      color: #1d1d1f;
    }

    input, textarea, select, button {
      font-family: inherit;
      font-size: 14px;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin: 5px 0;
      width: 100%;
    }

    button[type="submit"], .action-btn {
      background-color: #007aff;
      color: white;
      border: none;
      transition: background-color 0.2s ease;
    }

    button[type="submit"]:hover, .action-btn:hover {
      background-color: #005ecb;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background-color: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }

    th, td {
      padding: 10px 16px;
      border-bottom: 1px solid #e0e0e0;
      text-align: left;
      white-space: pre-wrap;
      word-break: break-word;
    }

    th {
      background-color: #f2f2f7;
    }

    .section {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }

    .hidden {
      display: none !important;
    }

    #loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 20px 30px;
      border-radius: 12px;
      z-index: 9999;
    }

    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: space-around;
        box-shadow: none;
        border-bottom: 1px solid #eee;
      }

      .sidebar button {
        flex: 1 1 auto;
        text-align: center;
      }

      .main {
        padding: 10px;
      }
    }
  </style>
</head>
<body>

<div id="loginScreen" style="width:100%; height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; background:#fff;">
    <h1>ë ˆì‹œí”¼ ë§¤ë‹ˆì €</h1>
    <button onclick="startApp()" class="action-btn" style="width: 200px; margin-top: 10px;">ì‹œì‘í•˜ê¸°</button>
    <button onclick="document.getElementById('loadExcelInput').click()" class="action-btn" style="width: 200px;">ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <input type="file" id="loadExcelInput" accept=".xlsx" style="display:none" onchange="loadAppFromExcel()" />
  </div>

  <!-- âœ… ê¸°ì¡´ ì•± ì˜ì—­: ì´ ë¶€ë¶„ì„ <div id="app" class="hidden"> ë¡œ ê°ì‹¸ ì£¼ì„¸ìš” -->
  <div id="app" class="hidden">
  <nav class="sidebar">
    <button onclick="showSection('prepSection')">í”„ë©</button>
    <button onclick="showSection('recipeSection')">ë ˆì‹œí”¼</button>
    <button onclick="showSection('ingredientSection')">ì¬ë£Œ</button>
    <button onclick="showSection('settingSection')">ì„¤ì •</button>
    <button onclick="logoutApp()">ë¡œê·¸ì•„ì›ƒ</button>
  </nav>

  <main class="main">
  
  <!-- âœ… ë ˆì‹œí”¼ ì„¹ì…˜ -->
    <div id="recipeSection" class="section hidden">
      <h2>ë ˆì‹œí”¼</h2>
      <button onclick="showAddRecipeForm()" class="action-btn">ë ˆì‹œí”¼ ì¶”ê°€</button>
      <div id="addRecipeForm" class="hidden">
  <h3>ë ˆì‹œí”¼ ì¶”ê°€</h3>

  <input type="text" id="newRecipeName" placeholder="ìš”ë¦¬ëª…" /><br />
  <input type="number" id="sellingPrice" placeholder="íŒë§¤ê°€" />

<div style="margin-top: 10px;">
  <span id="recipeTotalPrice">ì´ ì›ê°€: 0ì›</span>
  <span id="costRate" style="margin-left: 20px;"></span>
</div>

  <textarea id="platingSteps" placeholder="í”Œë ˆì´íŒ… ìˆœì„œ (ì—¬ëŸ¬ ì¤„ ì…ë ¥ ê°€ëŠ¥)" rows="4"></textarea><br />
  <textarea id="recipeMemo" placeholder="ë ˆì‹œí”¼ ë©”ëª¨" rows="4"></textarea><br />

  <div id="recipeForms"></div>

  <button onclick="addRecipeCategory()" class="action-btn">ë¶„ë¥˜ ì¶”ê°€</button>
  <button onclick="addRecipe()" class="action-btn">ë ˆì‹œí”¼ ì €ì¥</button>
  <button onclick="hideAddRecipeForm()" class="action-btn">ë ˆì‹œí”¼ ì¶”ê°€ ì·¨ì†Œ</button>
</div>
      <div id="recipeList"></div>
    </div>
    
    <!-- âœ… ì¬ë£Œ ì„¹ì…˜ -->
    <div id="ingredientSection" class="section hidden">
      <h2>ì¬ë£Œ</h2>
      <div>
        <h3>ì¬ë£Œ ì¶”ê°€</h3>
        <input type="text" id="newIngredientCategory" placeholder="ë¶„ë¥˜ (ì˜ˆ: ìœ¡ë¥˜)" /><br />
        <input type="text" id="newIngredientName" placeholder="ì¬ë£Œ ì´ë¦„" /><br />
        <input type="number" id="newIngredientQuantity" placeholder="ìˆ˜ëŸ‰" />
        <select id="newIngredientUnit"></select><br />
        <input type="number" id="newIngredientPrice" placeholder="ê°€ê²©" /><br />
        <button onclick="addIngredientItem()" class="action-btn">ì¬ë£Œ ì¶”ê°€</button>
      </div>
      <div style="margin-top: 20px;">
        <h3>ì¬ë£Œ ë¦¬ìŠ¤íŠ¸</h3>
        <button onclick="exportIngredientToExcel()" class="action-btn">ì¬ë£Œ ë‚´ë³´ë‚´ê¸°</button>
        <input type="file" id="importIngredientExcel" accept=".xlsx, .xls" style="display:none" onchange="importIngredientFromExcel()" />
      <button onclick="document.getElementById('importIngredientExcel').click()" class="action-btn">ì¬ë£Œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <table id="ingredientTable">
          <thead>
            <tr>
              <th><button onclick="sortIngredients('category', 'asc')" style="font-size: 8px; padding: 0px 0px;">â–²</button> ë¶„ë¥˜ <button onclick="sortIngredients('category', 'desc')" style="font-size: 8px; padding: 0px 0px;">â–¼</button></th>
              <th>ì¬ë£Œ</th>
              <th>ìˆ˜ëŸ‰</th>
              <th>ë‹¨ìœ„</th>
              <th>ê°€ê²©</th>
              <th>ë‹¨ê°€</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div id="prepSection" class="section hidden">
      <h2>í”„ë©</h2>
      <h3>í”„ë© í•­ëª© ì¶”ê°€</h3>
      <input type="text" id="prepDish" placeholder="ìš”ë¦¬ëª…" /><br />
      <textarea id="prepName" placeholder="í”„ë©"></textarea><br />
      <textarea id="prepIngredient" placeholder="ì¬ë£Œ"></textarea><br />
      <button id="addPrepBtn" class="action-btn">í”„ë© ì¶”ê°€</button>
      <button onclick="exportPrepToExcel()" class="action-btn">í”„ë© ë‚´ë³´ë‚´ê¸°</button>
      <input type="file" id="prepUploadFile" accept=".xlsx" style="display:none" onchange="importPrepFromExcel()" />
      <button onclick="document.getElementById('prepUploadFile').click()" class="action-btn">í”„ë© ë¶ˆëŸ¬ì˜¤ê¸°</button>

      <div style="margin-top: 20px;">
        <h3>í”„ë© ë¦¬ìŠ¤íŠ¸</h3>
        <button onclick="clearPrepList()" class="action-btn">ì „ì²´ ì‚­ì œ</button>
        <table id="prepTable">
          <thead>
            <tr><th>ìš”ë¦¬</th><th>í”„ë©</th><th>ì¬ë£Œ</th><th>ì‚­ì œ</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="settingSection" class="section hidden">
      <h2>ì„¤ì •</h2>
      <button onclick="toggleUnitInput()" class="action-btn">ë‹¨ìœ„ ì¶”ê°€</button>
      <div id="unitInputArea" style="display:none; margin-top: 10px;">
        <input type="text" id="unitInput" placeholder="ì˜ˆ: g, ml, ê°œ ë“±" />
        <button onclick="addUnit()" class="action-btn">ì €ì¥</button>
      </div>
      <div id="unitList" style="margin-top: 20px; max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: #fff;">
        <h3>ë“±ë¡ëœ ë‹¨ìœ„</h3>
        <ul id="unitItems" style="padding-left: 20px; margin: 0;"></ul>
      </div>
    </div>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
  
  const appData = {
  units: [],
  ingredients: [],
  recipes: []
};

let editingRecipeIndex = null;

  // ğŸ”½ ì—¬ê¸° ì•„ë˜ìª½ì— ë„£ìœ¼ë©´ ë©ë‹ˆë‹¤
  function deleteRecipe(index) {
    if (confirm("ì •ë§ ì´ ë ˆì‹œí”¼ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      appData.recipes.splice(index, 1);
      renderRecipeList();
    }
  }


function startApp() {
  // ê¸°ë³¸ ë°ì´í„° ë¡œë“œ (í•„ìš” ì‹œ ì§ì ‘ ì‘ì„±)
  appData.units = ['g', 'ml', 'ê°œ'];
  appData.ingredients = [];
  appData.recipes = [];

  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('app').classList.remove('hidden');
  showSection('recipeSection'); // ê¸°ë³¸ ì§„ì… ì„¹ì…˜
}

function loadAppFromExcel() {
  const file = document.getElementById('loadExcelInput').files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function (e) {
    const data = new Uint8Array(e.target.result);
    const wb = XLSX.read(data, { type: 'array' });

    // âœ… 1. Ingredients ì‹œíŠ¸
    const ingredients = XLSX.utils.sheet_to_json(wb.Sheets['Ingredients'], { header: 1 });
    appData.ingredients = ingredients.slice(1).map(row => ({
      category: row[0], name: row[1], quantity: row[2], unit: row[3], price: row[4], unitPrice: row[5]
    }));

    const ingredientTbody = document.getElementById('ingredientTable').querySelector('tbody');
    ingredientTbody.innerHTML = '';
    appData.ingredients.forEach(item => {
      const tr = ingredientTbody.insertRow();
      tr.insertCell(0).textContent = item.category;
      tr.insertCell(1).textContent = item.name;
      tr.insertCell(2).textContent = item.quantity;
      tr.insertCell(3).textContent = item.unit;
      tr.insertCell(4).textContent = item.price;
      tr.insertCell(5).textContent = item.unitPrice;
      const delCell = tr.insertCell(6);
      const btn = document.createElement('button');
      btn.textContent = 'ì‚­ì œ';
      btn.onclick = () => tr.remove();
      delCell.appendChild(btn);
    });

    // âœ… 2. Recipes ì‹œíŠ¸
    const recipes = XLSX.utils.sheet_to_json(wb.Sheets['Recipes'], { header: 1 });
    appData.recipes = [];
    const recipeMap = new Map();
    for (let i = 1; i < recipes.length; i++) {
      const row = recipes[i];
      if (!row || row.length < 15) continue;
      const [
        name, price, totalCost, costRate,
        categoryName, categoryCount, subtotal,
        ingName, usage, unit, usagePrice,
        ingQty, ingUnit, ingPrice, ingUnitPrice
      ] = row;

      if (!recipeMap.has(name)) {
        recipeMap.set(name, {
          name,
          price: parseFloat(price) || 0,
          plating: '',
          memo: '',
          categories: []
        });
      }

      const recipe = recipeMap.get(name);
      let category = recipe.categories.find(c => c.categoryName === categoryName);
      if (!category) {
        category = {
          categoryName,
          categoryCount,
          subtotal,
          ingredients: []
        };
        recipe.categories.push(category);
      }

      category.ingredients.push({
        name: ingName,
        usage,
        unit,
        usagePrice,
        ingredientQty: ingQty,
        ingredientUnit: ingUnit,
        ingredientPrice: ingPrice,
        ingredientUnitPrice: ingUnitPrice
      });
    }
    appData.recipes = Array.from(recipeMap.values());

    // âœ… 3. Units ì‹œíŠ¸ (ëŒ€ì†Œë¬¸ì ë¬´ê´€í•˜ê²Œ ê²€ìƒ‰)
    const unitSheetName = wb.SheetNames.find(name => name.toLowerCase() === 'units');
    const unitSheet = unitSheetName ? wb.Sheets[unitSheetName] : null;

    if (unitSheet) {
      const units = XLSX.utils.sheet_to_json(unitSheet, { header: 1 });
      appData.units = units.slice(1).map(row => row[0]).filter(Boolean);

      const unitUl = document.getElementById('unitItems');
      unitUl.innerHTML = '';
      appData.units.forEach(unit => {
        const li = document.createElement('li');
        const span = document.createElement('span');
        span.textContent = unit;
        li.appendChild(span);
        const delBtn = document.createElement('button');
        delBtn.textContent = 'ì‚­ì œ';
        delBtn.style.marginLeft = '10px';
        delBtn.onclick = () => {
          li.remove();
          const index = appData.units.indexOf(unit);
          if (index > -1) appData.units.splice(index, 1);
          updateIngredientUnitOptions(); // ì‚­ì œ í›„ select ê°±ì‹ 
        };
        li.appendChild(delBtn);
        unitUl.appendChild(li);
      });

      updateIngredientUnitOptions();
    } else {
      alert('âš ï¸ ì—‘ì…€ì— ë‹¨ìœ„ ë°ì´í„°(Units ì‹œíŠ¸)ê°€ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ë‹¨ìœ„ë¥¼ ì ìš©í•©ë‹ˆë‹¤.');
      appData.units = ['g', 'ml', 'ê°œ'];
      updateIngredientUnitOptions();
    }

    // âœ… 4. PrepList ì‹œíŠ¸
    const prepList = XLSX.utils.sheet_to_json(wb.Sheets['PrepList'], { header: 1 });
    const tbody = document.getElementById('prepTable').getElementsByTagName('tbody')[0];
    tbody.innerHTML = '';
    for (let i = 1; i < prepList.length; i++) {
      const row = prepList[i];
      if (!row || row.length < 3) continue;
      const tr = tbody.insertRow();
      tr.insertCell(0).textContent = row[0];
      tr.insertCell(1).innerHTML = (row[1] || '').replace(/\n/g, '<br>');
      tr.insertCell(2).innerHTML = (row[2] || '').replace(/\n/g, '<br>');
      const delCell = tr.insertCell(3);
      const btn = document.createElement('button');
      btn.textContent = 'ì‚­ì œ';
      btn.onclick = () => tr.remove();
      delCell.appendChild(btn);
    }

    // âœ… í™”ë©´ ì „í™˜ ë° ë Œë”ë§
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('app').classList.remove('hidden');
    renderRecipeList();
    showSection('recipeSection');
  };

  reader.readAsArrayBuffer(file);
}


 function logoutApp() {
  appData.units = Array.from(document.querySelectorAll('#unitItems li span'))
    .map(span => span.textContent.trim())
    .filter(Boolean);

  const wb = XLSX.utils.book_new();

  // ì¬ë£Œ ì‹œíŠ¸
  const ingTable = document.getElementById('ingredientTable');
  const ingSheet = XLSX.utils.table_to_sheet(ingTable);
  XLSX.utils.book_append_sheet(wb, ingSheet, 'Ingredients');

  // í”„ë© ì‹œíŠ¸
  const prepTable = document.getElementById('prepTable');
  const prepSheet = XLSX.utils.table_to_sheet(prepTable);
  XLSX.utils.book_append_sheet(wb, prepSheet, 'PrepList');

  // ë ˆì‹œí”¼ ì‹œíŠ¸
  const recipeRows = [['ë ˆì‹œí”¼ëª…', 'íŒë§¤ê°€', 'ì´ì›ê°€', 'ì›ê°€ìœ¨', 'ë¶„ë¥˜ëª…', 'ì†Œê³„ìˆ˜ëŸ‰', 'ì†Œê³„', 'ì¬ë£Œëª…', 'ì‚¬ìš©ëŸ‰', 'ë‹¨ìœ„', 'ì‚¬ìš© ë‹¨ê°€', 'ì¬ë£Œ ìˆ˜ëŸ‰', 'ì¬ë£Œ ë‹¨ìœ„', 'ì¬ë£Œ ê°€ê²©', 'ì¬ë£Œ ë‹¨ê°€']];
  appData.recipes.forEach(recipe => {
    let totalCost = 0;
    recipe.categories.forEach(cat => {
      cat.ingredients.forEach(ing => {
        totalCost += parseFloat(ing.usagePrice || 0);
        recipeRows.push([
          recipe.name,
          recipe.price,
          '', '', // ì´ì›ê°€, ì›ê°€ìœ¨ ë‚˜ì¤‘ì— ì±„ì›€
          cat.categoryName,
          cat.categoryCount,
          cat.subtotal,
          ing.name,
          ing.usage,
          ing.unit,
          ing.usagePrice,
          ing.ingredientQty,
          ing.ingredientUnit,
          ing.ingredientPrice,
          ing.ingredientUnitPrice
        ]);
      });
    });
    const firstRow = recipeRows.find(row => row[0] === recipe.name);
    if (firstRow) {
      firstRow[2] = totalCost.toFixed(2);
      firstRow[3] = recipe.price > 0 ? ((totalCost / recipe.price) * 100).toFixed(2) + '%' : '0%';
    }
  });
  const recipeSheet = XLSX.utils.aoa_to_sheet(recipeRows);
  XLSX.utils.book_append_sheet(wb, recipeSheet, 'Recipes');

  // ë‹¨ìœ„ ì‹œíŠ¸
  const unitRows = [['ë‹¨ìœ„']];
  appData.units.forEach(unit => unitRows.push([unit]));
  const unitSheet = XLSX.utils.aoa_to_sheet(unitRows);
  XLSX.utils.book_append_sheet(wb, unitSheet, 'Units');

  // âœ… íŒŒì¼ ì €ì¥ (ëª¨ë°”ì¼ ëŒ€ì‘)
  const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
  const blob = new Blob([wbout], {
    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
  });

  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'ì „ì²´_ë°ì´í„°_ë°±ì—….xlsx';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  // í™”ë©´ ì „í™˜
  document.getElementById('app').classList.add('hidden');
  document.getElementById('loginScreen').style.display = 'flex';

  location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
}


  
  
    function showSection(id) {
      document.querySelectorAll('.section').forEach(sec => sec.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      
  if (id === 'ingredientSection') {
    updateIngredientUnitOptions(); // âœ… ì¬ë£Œ ë©”ë‰´ ì—´ë¦´ ë•Œ ë‹¨ìœ„ ëª©ë¡ ì—…ë°ì´íŠ¸
  }
}
    // showSection('prepSection'); // ê¸°ë³¸ í‘œì‹œ ì œê±°
    
function addUnit() {
  const input = document.getElementById('unitInput');
  const unit = input.value.trim();
  if (!unit) return;
  const ul = document.getElementById('unitItems');
  const existingUnits = Array.from(ul.children).map(li => li.firstChild.textContent.trim());
  if (existingUnits.includes(unit)) {
    alert('ì´ë¯¸ ë“±ë¡ëœ ë‹¨ìœ„ì…ë‹ˆë‹¤.');
    input.value = '';
    return;
  }
  const li = document.createElement('li');
  const span = document.createElement('span');
  span.textContent = unit;
  li.appendChild(span);
  const delBtn = document.createElement('button');
  delBtn.textContent = 'ì‚­ì œ';
  delBtn.style.marginLeft = '10px';
  delBtn.onclick = () => {
    li.remove();
    const index = appData.units.indexOf(unit);
    if (index > -1) appData.units.splice(index, 1);
  };
  li.appendChild(delBtn);
  ul.appendChild(li);
  //  ğŸ”¥  appData.unitsì— ì¶”ê°€
  appData.units.push(unit);
  // ë ˆì‹œí”¼ í¼ ë‚´ì˜ ëª¨ë“  ë‹¨ìœ„ ì„ íƒ ìš”ì†Œ ì—…ë°ì´íŠ¸
  const recipeForms = document.getElementById('recipeForms');
  const selectElements = recipeForms.querySelectorAll('.recipe-ingredient select');
  selectElements.forEach(select => {
    updateRecipeIngredientUnitOptions(select); // ìœ„ì—ì„œ ì •ì˜í•œ í•¨ìˆ˜ ì¬ì‚¬ìš©
  });
  input.value = '';
}


function addIngredientItem() {
  const category = document.getElementById('newIngredientCategory').value.trim();
  const name = document.getElementById('newIngredientName').value.trim();
  const quantity = parseFloat(document.getElementById('newIngredientQuantity').value);
  const unit = document.getElementById('newIngredientUnit').value.trim();
  const price = parseFloat(document.getElementById('newIngredientPrice').value);

  if (!category || !name) {
    alert('ë¶„ë¥˜, ì¬ë£Œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  

  const unitPrice = quantity > 0 ? (price / quantity).toFixed(2) : '0';

  const tbody = document.getElementById('ingredientTable').querySelector('tbody');
  const tr = tbody.insertRow();

  tr.insertCell(0).textContent = category;
  tr.insertCell(1).textContent = name;
  tr.insertCell(2).textContent = quantity;
  tr.insertCell(3).textContent = unit;
  tr.insertCell(4).textContent = price.toLocaleString();
  tr.insertCell(5).textContent = unitPrice;

  const delCell = tr.insertCell(6);
  const btn = document.createElement('button');
  btn.textContent = 'ì‚­ì œ';
  btn.onclick = () => tr.remove();
  delCell.appendChild(btn);

  // ì…ë ¥ì°½ ì´ˆê¸°í™”
  document.getElementById('newIngredientCategory').value = '';
  document.getElementById('newIngredientName').value = '';
  document.getElementById('newIngredientQuantity').value = '';
  document.getElementById('newIngredientUnit').value = '';
  document.getElementById('newIngredientPrice').value = '';
}

function updateIngredientUnitOptions() {
  const select = document.getElementById('newIngredientUnit');
  select.innerHTML = ''; // ì´ˆê¸°í™”

  appData.units.forEach(unit => {
    const option = document.createElement('option');
    option.value = unit;
    option.textContent = unit;
    select.appendChild(option);
  });
}


function sortIngredients(column, direction) {
  const table = document.getElementById('ingredientTable');
  const tbody = table.querySelector('tbody');
  const rows = Array.from(tbody.rows);

  const columnIndexMap = {
    category: 0,
    name: 1,
    quantity: 2,
    unit: 3,
    price: 4,
    unitPrice: 5,
  };

  const index = columnIndexMap[column];
  const isAsc = direction === 'asc';

  rows.sort((a, b) => {
    const valA = a.cells[index].textContent.trim();
    const valB = b.cells[index].textContent.trim();

    const numA = parseFloat(valA.replace(/,/g, ''));
    const numB = parseFloat(valB.replace(/,/g, ''));

    const isNumber = !isNaN(numA) && !isNaN(numB);
    if (isNumber) {
      return isAsc ? numA - numB : numB - numA;
    } else {
      return isAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
    }
  });

  rows.forEach(row => tbody.appendChild(row));
}

    document.getElementById('addPrepBtn').addEventListener('click', () => {
      const table = document.getElementById('prepTable').getElementsByTagName('tbody')[0];
      const dish = document.getElementById('prepDish').value;
      const name = document.getElementById('prepName').value;
      const ingredient = document.getElementById('prepIngredient').value;
      if (!dish || !name) {
        alert('ìš”ë¦¬ëª…ê³¼ í”„ë© ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      const row = table.insertRow();
      row.insertCell(0).textContent = dish;
      row.insertCell(1).innerHTML = name.replace(/\n/g, '<br>');
      row.insertCell(2).innerHTML = ingredient.replace(/\n/g, '<br>');
      const deleteCell = row.insertCell(3);
      const delBtn = document.createElement('button');
      delBtn.textContent = 'ì‚­ì œ';
      delBtn.onclick = () => row.remove();
      deleteCell.appendChild(delBtn);
      document.getElementById('prepDish').value = '';
      document.getElementById('prepName').value = '';
      document.getElementById('prepIngredient').value = '';
    });

    function clearPrepList() {
      const table = document.getElementById('prepTable').getElementsByTagName('tbody')[0];
      table.innerHTML = '';
    }
    
//ì—¬ê¸°ì„œ ë¶€í„° ë ˆì‹œí”¼ í•¨ìˆ˜
function showAddRecipeForm() {
    document.getElementById("addRecipeForm").classList.remove("hidden");
  }

  function hideAddRecipeForm() {
  document.getElementById("addRecipeForm").classList.add("hidden");
  editingRecipeIndex = null; // âœ… í¸ì§‘ ì¸ë±ìŠ¤ ì´ˆê¸°í™”
}
  
  function addRecipeCategory() {
  const container = document.getElementById('recipeForms');

  const wrapper = document.createElement('div');
  wrapper.classList.add('recipe-category-block');
  wrapper.style.borderTop = '1px solid #ddd';
  wrapper.style.paddingTop = '20px';
  wrapper.style.marginTop = '20px';

  wrapper.innerHTML = `
    <input type="text" placeholder="ë¶„ë¥˜ëª…" class="category-name" />

    <div style="margin-top: 10px;">ì†Œê³„: <span class="category-subtotal">0 ì›</span></div>
    <input type="number" class="category-count" placeholder="ì†Œê³„ ìˆ˜ëŸ‰" style="margin: 5px 0; width: 100%;" />

    <button onclick="calculateCategorySubtotal(this)" class="action-btn">ê³„ì‚°</button>
    <button onclick="addIngredientToCategory(this)" class="action-btn">ì¬ë£Œì¶”ê°€</button>

    <div style="border-top: 1px solid #ddd; margin: 10px 0;"></div>

    <div class="ingredient-list" style="margin-top: 10px;"></div>
    
    <button onclick="removeCategoryBlock(this)" class="action-btn">ë¶„ë¥˜ ì‚­ì œ</button>
  `;

  container.appendChild(wrapper);
}


function removeCategoryBlock(button) {
  const categoryDiv = button.closest('.recipe-category-block');
  categoryDiv.remove();
}

function addIngredientToCategory(button) {
  const ingredientList = button.closest('.recipe-category-block').querySelector('.ingredient-list');
  const wrapper = document.createElement('div');
  wrapper.classList.add('ingredient-entry');
  wrapper.style.padding = '10px';
  wrapper.style.border = '1px solid #ddd';
  wrapper.style.borderRadius = '8px';
  wrapper.style.marginBottom = '10px';
  wrapper.style.background = '#f9f9f9';

  // â–¶ ì…ë ¥ ìš”ì†Œ ìƒì„±
  const inputName = document.createElement('input');
  inputName.placeholder = 'ì¬ë£Œëª…';
  const inputUsage = document.createElement('input');
  inputUsage.type = 'number';
  inputUsage.placeholder = 'ì‚¬ìš©ëŸ‰';
  const selectUnit = document.createElement('select');
  getRegisteredUnits().forEach(unit => {
    const opt = document.createElement('option');
    opt.value = opt.textContent = unit;
    selectUnit.appendChild(opt);
  });
  const inputUsagePrice = document.createElement('input');
  inputUsagePrice.placeholder = 'ì‚¬ìš© ë‹¨ê°€';
  inputUsagePrice.readOnly = true;

  const inputIngredientQty = document.createElement('input');
  inputIngredientQty.placeholder = 'ì¬ë£Œ ìˆ˜ëŸ‰';
  inputIngredientQty.readOnly = true;

  const inputIngredientUnit = document.createElement('input');
  inputIngredientUnit.placeholder = 'ì¬ë£Œ ë‹¨ìœ„';
  inputIngredientUnit.readOnly = true;

  const inputIngredientPrice = document.createElement('input');
  inputIngredientPrice.placeholder = 'ì¬ë£Œ ê°€ê²©';
  inputIngredientPrice.readOnly = true;

  const inputIngredientUnitPrice = document.createElement('input');
  inputIngredientUnitPrice.placeholder = 'ì¬ë£Œ ë‹¨ê°€';
  inputIngredientUnitPrice.readOnly = true;


  // â–¶ ì‚­ì œ ë²„íŠ¼
  const delBtn = document.createElement('button');
  delBtn.textContent = 'ì‚­ì œ';
  delBtn.classList.add('action-btn');
  delBtn.onclick = () => wrapper.remove();

  // â–¶ UI êµ¬ì„±
  const row1 = document.createElement('div');
  row1.style.display = 'flex';
  row1.style.gap = '8px';
  row1.style.flexWrap = 'wrap';
  row1.append(inputName, inputUsage, selectUnit, inputUsagePrice);

  const row2 = document.createElement('div');
  row2.style.display = 'flex';
  row2.style.gap = '8px';
  row2.style.flexWrap = 'wrap';
  row2.append(inputIngredientQty, inputIngredientUnit, inputIngredientPrice, inputIngredientUnitPrice);

  const bottom = document.createElement('div');
  bottom.style.marginTop = '10px';
  bottom.appendChild(delBtn);

  wrapper.append(row1, row2, bottom);
  ingredientList.prepend(wrapper);  // ë²„íŠ¼ ë°”ë¡œ ì•„ë˜ì— ì¶”ê°€

  // â–¶ ìë™ ì±„ì›€ - ì¬ë£Œëª… ê¸°ì¤€
  inputName.addEventListener('change', () => {
    const data = getIngredientDataByName(inputName.value);
    if (data) {
      inputIngredientQty.value = data.quantity;
      inputIngredientUnit.value = data.unit;
      inputIngredientPrice.value = data.price;
      inputIngredientUnitPrice.value = data.unitPrice;
      // ì‚¬ìš© ë‹¨ê°€ë„ ì¬ê³„ì‚°
      const usage = parseFloat(inputUsage.value) || 0;
      inputUsagePrice.value = (usage * data.unitPrice).toFixed(2);
    }
  });

  // â–¶ ì‚¬ìš©ëŸ‰ ë³€ê²½ ì‹œ ì‚¬ìš© ë‹¨ê°€ ê³„ì‚° ë° ì´ ì›ê°€/ì›ê°€ìœ¨ ì—…ë°ì´íŠ¸
  inputUsage.addEventListener('input', () => {
    const usage = parseFloat(inputUsage.value) || 0;
    const unitPrice = parseFloat(inputIngredientUnitPrice.value) || 0;
    inputUsagePrice.value = (usage * unitPrice).toFixed(2);
    calculateCategorySubtotal(button);  //  âœ…  ì†Œê³„, ì´ ì›ê°€, ì›ê°€ìœ¨ ì¬ê³„ì‚°
  });
}


function calculateCategorySubtotal(button) {
  const block = button.closest('.recipe-category-block');
  const rows = block.querySelectorAll('.ingredient-row');

  let total = 0;
  let count = 0;

  rows.forEach(row => {
    const qty = parseFloat(row.querySelectorAll('input')[1].value) || 0;
    const price = parseFloat(row.querySelectorAll('input')[2].value) || 0;
    total += qty * price;
    count += 1;
  });

  block.querySelector('.category-subtotal').textContent = `${total.toLocaleString()} ì›`;
  block.querySelector('.category-count').textContent = count;
}

function getRegisteredUnits() {
  return Array.from(document.querySelectorAll('#unitItems li span')).map(span => span.textContent);
}

function getIngredientDataByName(name) {
  const rows = document.querySelectorAll('#ingredientTable tbody tr');
  for (const row of rows) {
    const itemName = row.cells[1]?.textContent.trim();
    if (itemName === name.trim()) {
      return {
        quantity: parseFloat(row.cells[2]?.textContent) || 0,
        unit: row.cells[3]?.textContent.trim(),
        price: parseFloat(row.cells[4]?.textContent.replace(/,/g, '')) || 0,
        unitPrice: parseFloat(row.cells[5]?.textContent.replace(/,/g, '')) || 0,
      };
    }
  }
  return null;
}

function calculateTotalCostAndRate() {
  const categoryBlocks = document.querySelectorAll('.recipe-category-block');
  let totalCost = 0;
  categoryBlocks.forEach(block => {
    const subtotalText = block.querySelector('.category-subtotal')?.textContent || '0';
    const subtotal = parseFloat(subtotalText.replace(/[^\d.]/g, '')) || 0;
    totalCost += subtotal;
  });
  const sellingPrice = parseFloat(document.getElementById('sellingPrice')?.value) || 0;
  const costRate = (sellingPrice > 0)
    ? ((totalCost / sellingPrice) * 100).toFixed(2)
    : '0.00';
  document.getElementById('recipeTotalPrice').textContent = `ì´ ì›ê°€: ${totalCost.toFixed(2)}ì›`;
  document.getElementById('costRate').textContent = `ì›ê°€ìœ¨: ${costRate}%`;
}



function calculateCategorySubtotal(button) {
  const block = button.closest('.recipe-category-block');
  const rows = block.querySelectorAll('.ingredient-entry');
  let totalUsagePrice = 0;
  let totalUsageAmount = 0;
  rows.forEach(entry => {
    const usage = parseFloat(entry.querySelector('input[placeholder="ì‚¬ìš©ëŸ‰"]')?.value) || 0;
    const usagePrice = parseFloat(entry.querySelector('input[placeholder="ì‚¬ìš© ë‹¨ê°€"]')?.value) || 0;
    totalUsageAmount += usage;
    totalUsagePrice += usagePrice;
  });
  const categoryCountInput = block.querySelector('.category-count');
  const categoryCount = parseFloat(categoryCountInput?.value);
  let finalSubtotal = totalUsagePrice;
  if (!isNaN(categoryCount) && categoryCount > 0 && totalUsageAmount > 0) {
    finalSubtotal = totalUsagePrice / (totalUsageAmount / categoryCount);
  }
  //  âœ…  ì†Œìˆ˜ì  ë‘˜ì§¸ ìë¦¬ê¹Œì§€ í‘œì‹œ
  block.querySelector('.category-subtotal').textContent = `${finalSubtotal.toFixed(2)} ì›`;
  calculateTotalCostAndRate(); //  âœ…  ì´ ì›ê°€ ë° ì›ê°€ìœ¨ ì¬ê³„ì‚°
}

function addRecipe() {
  const name = document.getElementById('newRecipeName').value.trim();
  const price = parseFloat(document.getElementById('sellingPrice').value) || 0;
  const plating = document.getElementById('platingSteps').value;
  const memo = document.getElementById('recipeMemo').value;

  if (!name) {
    alert("ë ˆì‹œí”¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
    return;
  }

  const recipe = {
    name,
    price,
    plating,
    memo,
    categories: [],
  };

  document.querySelectorAll('.recipe-category-block').forEach(block => {
    const categoryName = block.querySelector('.category-name').value;
    const categoryCount = block.querySelector('.category-count').value;
    const subtotal = block.querySelector('.category-subtotal').textContent;

    const ingredients = [];

    block.querySelectorAll('.ingredient-entry').forEach(entry => {
      ingredients.push({
        name: entry.querySelector('input[placeholder="ì¬ë£Œëª…"]').value,
        usage: entry.querySelector('input[placeholder="ì‚¬ìš©ëŸ‰"]').value,
        unit: entry.querySelector('select').value,
        usagePrice: entry.querySelector('input[placeholder="ì‚¬ìš© ë‹¨ê°€"]').value,
        ingredientQty: entry.querySelector('input[placeholder="ì¬ë£Œ ìˆ˜ëŸ‰"]').value,
        ingredientUnit: entry.querySelector('input[placeholder="ì¬ë£Œ ë‹¨ìœ„"]').value,
        ingredientPrice: entry.querySelector('input[placeholder="ì¬ë£Œ ê°€ê²©"]').value,
        ingredientUnitPrice: entry.querySelector('input[placeholder="ì¬ë£Œ ë‹¨ê°€"]').value,
      });
    });

    recipe.categories.push({ categoryName, categoryCount, subtotal, ingredients });
  });

  // ìˆ˜ì • ë˜ëŠ” ì¶”ê°€
  if (editingRecipeIndex !== null) {
    appData.recipes[editingRecipeIndex] = recipe;
    editingRecipeIndex = null;
  } else {
    appData.recipes.push(recipe);
  }

  renderRecipeList();
  hideAddRecipeForm();
  calculateTotalCostAndRate(); // ì›ê°€ìœ¨ ì—…ë°ì´íŠ¸
}



function renderRecipeList() {
  const container = document.getElementById('recipeList');
  container.innerHTML = '';

  appData.recipes.forEach((recipe, index) => {
    const div = document.createElement('div');
    div.style.marginBottom = '10px';
    div.innerHTML = `
      <strong>${recipe.name}</strong> 
      <button onclick="loadRecipe(${index})">ë¶ˆëŸ¬ì˜¤ê¸°</button> 
      <button onclick="exportSingleRecipe(${index})">ë‚´ë³´ë‚´ê¸°</button>
      <button onclick="deleteRecipe(${index})">ì‚­ì œ</button> <!-- âœ… ì‚­ì œ ë²„íŠ¼ ì¶”ê°€ -->
    `;
    container.appendChild(div);
  });
}



function loadRecipe(index) {
  const recipe = appData.recipes[index];
  editingRecipeIndex = index; // âœ… í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ë ˆì‹œí”¼ ì¸ë±ìŠ¤ ì €ì¥
  showAddRecipeForm();

  document.getElementById('newRecipeName').value = recipe.name;
  document.getElementById('sellingPrice').value = recipe.price;
  document.getElementById('platingSteps').value = recipe.plating;
  document.getElementById('recipeMemo').value = recipe.memo;

  const container = document.getElementById('recipeForms');
  container.innerHTML = '';
  recipe.categories.forEach(cat => {
    addRecipeCategory();
    const lastBlock = container.lastChild;
    lastBlock.querySelector('.category-name').value = cat.categoryName;
    lastBlock.querySelector('.category-count').value = cat.categoryCount;
    lastBlock.querySelector('.category-subtotal').textContent = cat.subtotal;

    const ingList = lastBlock.querySelector('.ingredient-list');
    cat.ingredients.forEach(ing => {
      addIngredientToCategory(lastBlock.querySelector('button'));
      const lastEntry = ingList.firstChild;
      lastEntry.querySelector('input[placeholder="ì¬ë£Œëª…"]').value = ing.name;
lastEntry.querySelector('input[placeholder="ì‚¬ìš©ëŸ‰"]').value = ing.usage;
lastEntry.querySelector('select').value = ing.unit;
lastEntry.querySelector('input[placeholder="ì‚¬ìš© ë‹¨ê°€"]').value = ing.usagePrice;
lastEntry.querySelector('input[placeholder="ì¬ë£Œ ìˆ˜ëŸ‰"]').value = ing.ingredientQty;
lastEntry.querySelector('input[placeholder="ì¬ë£Œ ë‹¨ìœ„"]').value = ing.ingredientUnit;
lastEntry.querySelector('input[placeholder="ì¬ë£Œ ê°€ê²©"]').value = ing.ingredientPrice;
lastEntry.querySelector('input[placeholder="ì¬ë£Œ ë‹¨ê°€"]').value = ing.ingredientUnitPrice;
    });
  });
}


function exportSingleRecipe(index) {
  const recipe = appData.recipes[index];
  const wb = XLSX.utils.book_new();
  const rows = [];

  rows.push(['ë ˆì‹œí”¼ëª…', recipe.name]);
  rows.push(['íŒë§¤ê°€', recipe.price]);

  const totalCost = recipe.categories.reduce((sum, cat) => {
    return sum + parseFloat(cat.subtotal.replace(/[^\d.]/g, '') || 0);
  }, 0);

  const costRate = recipe.price > 0 ? ((totalCost / recipe.price) * 100).toFixed(2) + '%' : '0%';
  rows.push(['ì´ ì›ê°€', totalCost.toFixed(2)]);
  rows.push(['ì›ê°€ìœ¨', costRate]);
  rows.push([]);

  rows.push([
    'ë¶„ë¥˜ëª…', 'ì¬ë£Œëª…', 'ì‚¬ìš©ëŸ‰', 'ë‹¨ìœ„', 'ì‚¬ìš© ë‹¨ê°€',
    'ì¬ë£Œ ìˆ˜ëŸ‰', 'ì¬ë£Œ ë‹¨ìœ„', 'ì¬ë£Œ ê°€ê²©', 'ì¬ë£Œ ë‹¨ê°€'
  ]);

  recipe.categories.forEach(cat => {
    cat.ingredients.forEach(ing => {
      rows.push([
        cat.categoryName || '',
        ing.name || '',
        ing.usage || '',
        ing.unit || '',
        ing.usagePrice || '',
        ing.ingredientQty || '',
        ing.ingredientUnit || '',
        ing.ingredientPrice || '',
        ing.ingredientUnitPrice || ''
      ]);
    });
  });

  const ws = XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, 'ë ˆì‹œí”¼');

  const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
  const blob = new Blob([wbout], {
    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
  });

  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${recipe.name}_ë ˆì‹œí”¼.xlsx`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}







//ì—¬ê¸°ê¹Œì§€ ë ˆì‹œí”¼ í•¨ìˆ˜


    function exportIngredientToExcel() {
  const table = document.getElementById('ingredientTable');
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.table_to_sheet(table);
  XLSX.utils.book_append_sheet(wb, ws, 'Ingredients');

  const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
  const blob = new Blob([wbout], {
    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
  });

  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'ingredient_list.xlsx';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}


    function exportPrepToExcel() {
  const table = document.getElementById('prepTable');
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.table_to_sheet(table);
  XLSX.utils.book_append_sheet(wb, ws, 'PrepList');

  const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
  const blob = new Blob([wbout], {
    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
  });

  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'prep_list.xlsx';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}


function importIngredientFromExcel() {
  const fileInput = document.getElementById('importIngredientExcel');
  const file = fileInput.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function (e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    const tbody = document.getElementById('ingredientTable').querySelector('tbody');

    // âœ… ì¤‘ë³µ ì²´í¬ìš© Set ìƒì„± (ë¶„ë¥˜ + ì´ë¦„)
    const existingSet = new Set();
    Array.from(tbody.rows).forEach(row => {
      const category = row.cells[0]?.textContent.trim();
      const name = row.cells[1]?.textContent.trim();
      existingSet.add(`${category}::${name}`);
    });

    for (let i = 1; i < rows.length; i++) {
      const row = rows[i];
      if (!row || row.length < 6) continue;

      const category = (row[0] || '').toString().trim();
      const name = (row[1] || '').toString().trim();
      const quantity = row[2];
      const unit = row[3];
      const price = row[4];
      const unitPrice = row[5];

      const key = `${category}::${name}`;
      if (existingSet.has(key)) continue; // âœ… ì¤‘ë³µì´ë©´ ì¶”ê°€í•˜ì§€ ì•ŠìŒ

      const tr = tbody.insertRow();
      tr.insertCell(0).textContent = category;
      tr.insertCell(1).textContent = name;
      tr.insertCell(2).textContent = quantity;
      tr.insertCell(3).textContent = unit;
      tr.insertCell(4).textContent = price;
      tr.insertCell(5).textContent = unitPrice;

      const delCell = tr.insertCell(6);
      const delBtn = document.createElement('button');
      delBtn.textContent = 'ì‚­ì œ';
      delBtn.onclick = () => tr.remove();
      delCell.appendChild(delBtn);

      existingSet.add(key);
    }

    fileInput.value = ''; // íŒŒì¼ ì´ˆê¸°í™”
  };

  reader.readAsArrayBuffer(file);
}

    function importPrepFromExcel() {
      const fileInput = document.getElementById('prepUploadFile');
      const file = fileInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        const tbody = document.getElementById('prepTable').getElementsByTagName('tbody')[0];
        const existingSet = new Set();
        for (const row of tbody.rows) {
          const dish = row.cells[0]?.textContent.trim();
          const prep = row.cells[1]?.textContent.trim().replace(/\s+/g, ' ');
          existingSet.add(`${dish}::${prep}`);
        }
        for (let i = 1; i < rows.length; i++) {
          const row = rows[i];
          if (!row || row.every(cell => !cell)) continue;
          const dish = (row[1] || '').toString().trim();
          const prep = (row[2] || '').toString().trim().replace(/\r?\n/g, '<br>');
          const ingredient = (row[3] || '').toString().trim();
          const key = `${dish}::${prep}`;
          if (existingSet.has(key)) continue;
          const tr = tbody.insertRow();
          tr.insertCell(0).textContent = dish;
          tr.insertCell(1).innerHTML = prep.replace(/\n/g, '<br>');
          tr.insertCell(2).innerHTML = ingredient.replace(/\n/g, '<br>');
          const delCell = tr.insertCell(3);
          const btn = document.createElement('button');
          btn.textContent = 'ì‚­ì œ';
          btn.onclick = () => tr.remove();
          delCell.appendChild(btn);
          existingSet.add(key);
        }
        fileInput.value = '';
      };
      reader.readAsArrayBuffer(file);
    }

    function toggleUnitInput() {
      const inputArea = document.getElementById('unitInputArea');
      inputArea.style.display = inputArea.style.display === 'none' ? 'block' : 'none';
    }

    function addUnit() {
      const input = document.getElementById('unitInput');
      const unit = input.value.trim();
      if (!unit) return;
      const ul = document.getElementById('unitItems');
      const existingUnits = Array.from(ul.children).map(li => li.firstChild.textContent.trim());
      if (existingUnits.includes(unit)) {
        alert('ì´ë¯¸ ë“±ë¡ëœ ë‹¨ìœ„ì…ë‹ˆë‹¤.');
        input.value = '';
        return;
      }
      const li = document.createElement('li');
      const span = document.createElement('span');
      span.textContent = unit;
      li.appendChild(span);
      const delBtn = document.createElement('button');
      delBtn.textContent = 'ì‚­ì œ';
      delBtn.style.marginLeft = '10px';
      delBtn.onclick = () => li.remove();
      li.appendChild(delBtn);
      ul.appendChild(li);
      input.value = '';
    }
  </script>
</body>
</html>




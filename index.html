<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>레시피 매니저</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: #f5f5f7;
      margin: 0;
      height: 100vh;
    }
    
    #app {
  display: flex;
  height: 100vh;
}

    .sidebar {
      width: 220px;
      background: white;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.05);
    }

    .sidebar button {
      background: #e5e5ea;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      cursor: pointer;
      font-size: 14px;
      text-align: left;
      transition: background 0.2s ease;
    }

    .sidebar button:hover {
      background: #d1d1d6;
    }

    .main {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
    }

    h1, h2, h3 {
      color: #1d1d1f;
    }

    input, textarea, select, button {
      font-family: inherit;
      font-size: 14px;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin: 5px 0;
      width: 100%;
    }

    button[type="submit"], .action-btn {
      background-color: #007aff;
      color: white;
      border: none;
      transition: background-color 0.2s ease;
    }

    button[type="submit"]:hover, .action-btn:hover {
      background-color: #005ecb;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background-color: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }

    th, td {
      padding: 10px 16px;
      border-bottom: 1px solid #e0e0e0;
      text-align: left;
      white-space: pre-wrap;
      word-break: break-word;
    }

    th {
      background-color: #f2f2f7;
    }

    .section {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }

    .hidden {
      display: none !important;
    }

    #loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 20px 30px;
      border-radius: 12px;
      z-index: 9999;
    }

    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: space-around;
        box-shadow: none;
        border-bottom: 1px solid #eee;
      }

      .sidebar button {
        flex: 1 1 auto;
        text-align: center;
      }

      .main {
        padding: 10px;
      }
    }
  </style>
</head>
<body>

<div id="loginScreen" style="width:100%; height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; background:#fff;">
    <h1>레시피 매니저</h1>
    <button onclick="startApp()" class="action-btn" style="width: 200px; margin-top: 10px;">시작하기</button>
    <button onclick="document.getElementById('loadExcelInput').click()" class="action-btn" style="width: 200px;">불러오기</button>
    <input type="file" id="loadExcelInput" accept=".xlsx" style="display:none" onchange="loadAppFromExcel()" />
  </div>

  <!-- ✅ 기존 앱 영역: 이 부분을 <div id="app" class="hidden"> 로 감싸 주세요 -->
  <div id="app" class="hidden">
  <nav class="sidebar">
    <button onclick="showSection('prepSection')">프랩</button>
    <button onclick="showSection('recipeSection')">레시피</button>
    <button onclick="showSection('ingredientSection')">재료</button>
    <button onclick="showSection('settingSection')">설정</button>
    <button onclick="logoutApp()">로그아웃</button>
  </nav>

  <main class="main">
  
  <!-- ✅ 레시피 섹션 -->
    <div id="recipeSection" class="section hidden">
      <h2>레시피</h2>
      <button onclick="showAddRecipeForm()" class="action-btn">레시피 추가</button>
      <div id="addRecipeForm" class="hidden">
  <h3>레시피 추가</h3>

  <input type="text" id="newRecipeName" placeholder="요리명" /><br />
  <input type="number" id="sellingPrice" placeholder="판매가" />

<div style="margin-top: 10px;">
  <span id="recipeTotalPrice">총 원가: 0원</span>
  <span id="costRate" style="margin-left: 20px;"></span>
</div>

  <textarea id="platingSteps" placeholder="플레이팅 순서 (여러 줄 입력 가능)" rows="4"></textarea><br />
  <textarea id="recipeMemo" placeholder="레시피 메모" rows="4"></textarea><br />

  <div id="recipeForms"></div>

  <button onclick="addRecipeCategory()" class="action-btn">분류 추가</button>
  <button onclick="addRecipe()" class="action-btn">레시피 저장</button>
  <button onclick="hideAddRecipeForm()" class="action-btn">레시피 추가 취소</button>
</div>
      <div id="recipeList"></div>
    </div>
    
    <!-- ✅ 재료 섹션 -->
    <div id="ingredientSection" class="section hidden">
      <h2>재료</h2>
      <div>
        <h3>재료 추가</h3>
        <input type="text" id="newIngredientCategory" placeholder="분류 (예: 육류)" /><br />
        <input type="text" id="newIngredientName" placeholder="재료 이름" /><br />
        <input type="number" id="newIngredientQuantity" placeholder="수량" />
        <select id="newIngredientUnit"></select><br />
        <input type="number" id="newIngredientPrice" placeholder="가격" /><br />
        <button onclick="addIngredientItem()" class="action-btn">재료 추가</button>
      </div>
      <div style="margin-top: 20px;">
        <h3>재료 리스트</h3>
        <button onclick="exportIngredientToExcel()" class="action-btn">재료 내보내기</button>
        <input type="file" id="importIngredientExcel" accept=".xlsx, .xls" style="display:none" onchange="importIngredientFromExcel()" />
      <button onclick="document.getElementById('importIngredientExcel').click()" class="action-btn">재료 불러오기</button>
        <table id="ingredientTable">
          <thead>
            <tr>
              <th><button onclick="sortIngredients('category', 'asc')" style="font-size: 8px; padding: 0px 0px;">▲</button> 분류 <button onclick="sortIngredients('category', 'desc')" style="font-size: 8px; padding: 0px 0px;">▼</button></th>
              <th>재료</th>
              <th>수량</th>
              <th>단위</th>
              <th>가격</th>
              <th>단가</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div id="prepSection" class="section hidden">
      <h2>프랩</h2>
      <h3>프랩 항목 추가</h3>
      <input type="text" id="prepDish" placeholder="요리명" /><br />
      <textarea id="prepName" placeholder="프랩"></textarea><br />
      <textarea id="prepIngredient" placeholder="재료"></textarea><br />
      <button id="addPrepBtn" class="action-btn">프랩 추가</button>
      <button onclick="exportPrepToExcel()" class="action-btn">프랩 내보내기</button>
      <input type="file" id="prepUploadFile" accept=".xlsx" style="display:none" onchange="importPrepFromExcel()" />
      <button onclick="document.getElementById('prepUploadFile').click()" class="action-btn">프랩 불러오기</button>

      <div style="margin-top: 20px;">
        <h3>프랩 리스트</h3>
        <button onclick="clearPrepList()" class="action-btn">전체 삭제</button>
        <table id="prepTable">
          <thead>
            <tr><th>요리</th><th>프랩</th><th>재료</th><th>삭제</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="settingSection" class="section hidden">
      <h2>설정</h2>
      <button onclick="toggleUnitInput()" class="action-btn">단위 추가</button>
      <div id="unitInputArea" style="display:none; margin-top: 10px;">
        <input type="text" id="unitInput" placeholder="예: g, ml, 개 등" />
        <button onclick="addUnit()" class="action-btn">저장</button>
      </div>
      <div id="unitList" style="margin-top: 20px; max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: #fff;">
        <h3>등록된 단위</h3>
        <ul id="unitItems" style="padding-left: 20px; margin: 0;"></ul>
      </div>
    </div>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
  
  const appData = {
  units: [],
  ingredients: [],
  recipes: []
};

let editingRecipeIndex = null;

  // 🔽 여기 아래쪽에 넣으면 됩니다
  function deleteRecipe(index) {
    if (confirm("정말 이 레시피를 삭제하시겠습니까?")) {
      appData.recipes.splice(index, 1);
      renderRecipeList();
    }
  }


function startApp() {
  // 기본 데이터 로드 (필요 시 직접 작성)
  appData.units = ['g', 'ml', '개'];
  appData.ingredients = [];
  appData.recipes = [];

  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('app').classList.remove('hidden');
  showSection('recipeSection'); // 기본 진입 섹션
}

function loadAppFromExcel() {
  const file = document.getElementById('loadExcelInput').files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function (e) {
    const data = new Uint8Array(e.target.result);
    const wb = XLSX.read(data, { type: 'array' });

    // ✅ 1. Ingredients 시트
    const ingredients = XLSX.utils.sheet_to_json(wb.Sheets['Ingredients'], { header: 1 });
    appData.ingredients = ingredients.slice(1).map(row => ({
      category: row[0], name: row[1], quantity: row[2], unit: row[3], price: row[4], unitPrice: row[5]
    }));

    const ingredientTbody = document.getElementById('ingredientTable').querySelector('tbody');
    ingredientTbody.innerHTML = '';
    appData.ingredients.forEach(item => {
      const tr = ingredientTbody.insertRow();
      tr.insertCell(0).textContent = item.category;
      tr.insertCell(1).textContent = item.name;
      tr.insertCell(2).textContent = item.quantity;
      tr.insertCell(3).textContent = item.unit;
      tr.insertCell(4).textContent = item.price;
      tr.insertCell(5).textContent = item.unitPrice;
      const delCell = tr.insertCell(6);
      const btn = document.createElement('button');
      btn.textContent = '삭제';
      btn.onclick = () => tr.remove();
      delCell.appendChild(btn);
    });

    // ✅ 2. Recipes 시트
    const recipes = XLSX.utils.sheet_to_json(wb.Sheets['Recipes'], { header: 1 });
    appData.recipes = [];
    const recipeMap = new Map();
    for (let i = 1; i < recipes.length; i++) {
      const row = recipes[i];
      if (!row || row.length < 15) continue;
      const [
        name, price, totalCost, costRate,
        categoryName, categoryCount, subtotal,
        ingName, usage, unit, usagePrice,
        ingQty, ingUnit, ingPrice, ingUnitPrice
      ] = row;

      if (!recipeMap.has(name)) {
        recipeMap.set(name, {
          name,
          price: parseFloat(price) || 0,
          plating: '',
          memo: '',
          categories: []
        });
      }

      const recipe = recipeMap.get(name);
      let category = recipe.categories.find(c => c.categoryName === categoryName);
      if (!category) {
        category = {
          categoryName,
          categoryCount,
          subtotal,
          ingredients: []
        };
        recipe.categories.push(category);
      }

      category.ingredients.push({
        name: ingName,
        usage,
        unit,
        usagePrice,
        ingredientQty: ingQty,
        ingredientUnit: ingUnit,
        ingredientPrice: ingPrice,
        ingredientUnitPrice: ingUnitPrice
      });
    }
    appData.recipes = Array.from(recipeMap.values());

    // ✅ 3. Units 시트 (대소문자 무관하게 검색)
    const unitSheetName = wb.SheetNames.find(name => name.toLowerCase() === 'units');
    const unitSheet = unitSheetName ? wb.Sheets[unitSheetName] : null;

    if (unitSheet) {
      const units = XLSX.utils.sheet_to_json(unitSheet, { header: 1 });
      appData.units = units.slice(1).map(row => row[0]).filter(Boolean);

      const unitUl = document.getElementById('unitItems');
      unitUl.innerHTML = '';
      appData.units.forEach(unit => {
        const li = document.createElement('li');
        const span = document.createElement('span');
        span.textContent = unit;
        li.appendChild(span);
        const delBtn = document.createElement('button');
        delBtn.textContent = '삭제';
        delBtn.style.marginLeft = '10px';
        delBtn.onclick = () => {
          li.remove();
          const index = appData.units.indexOf(unit);
          if (index > -1) appData.units.splice(index, 1);
          updateIngredientUnitOptions(); // 삭제 후 select 갱신
        };
        li.appendChild(delBtn);
        unitUl.appendChild(li);
      });

      updateIngredientUnitOptions();
    } else {
      alert('⚠️ 엑셀에 단위 데이터(Units 시트)가 없습니다. 기본 단위를 적용합니다.');
      appData.units = ['g', 'ml', '개'];
      updateIngredientUnitOptions();
    }

    // ✅ 4. PrepList 시트
    const prepList = XLSX.utils.sheet_to_json(wb.Sheets['PrepList'], { header: 1 });
    const tbody = document.getElementById('prepTable').getElementsByTagName('tbody')[0];
    tbody.innerHTML = '';
    for (let i = 1; i < prepList.length; i++) {
      const row = prepList[i];
      if (!row || row.length < 3) continue;
      const tr = tbody.insertRow();
      tr.insertCell(0).textContent = row[0];
      tr.insertCell(1).innerHTML = (row[1] || '').replace(/\n/g, '<br>');
      tr.insertCell(2).innerHTML = (row[2] || '').replace(/\n/g, '<br>');
      const delCell = tr.insertCell(3);
      const btn = document.createElement('button');
      btn.textContent = '삭제';
      btn.onclick = () => tr.remove();
      delCell.appendChild(btn);
    }

    // ✅ 화면 전환 및 렌더링
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('app').classList.remove('hidden');
    renderRecipeList();
    showSection('recipeSection');
  };

  reader.readAsArrayBuffer(file);
}


 function logoutApp() {
  appData.units = Array.from(document.querySelectorAll('#unitItems li span'))
    .map(span => span.textContent.trim())
    .filter(Boolean);

  const wb = XLSX.utils.book_new();

  // 재료 시트
  const ingTable = document.getElementById('ingredientTable');
  const ingSheet = XLSX.utils.table_to_sheet(ingTable);
  XLSX.utils.book_append_sheet(wb, ingSheet, 'Ingredients');

  // 프랩 시트
  const prepTable = document.getElementById('prepTable');
  const prepSheet = XLSX.utils.table_to_sheet(prepTable);
  XLSX.utils.book_append_sheet(wb, prepSheet, 'PrepList');

  // 레시피 시트
  const recipeRows = [['레시피명', '판매가', '총원가', '원가율', '분류명', '소계수량', '소계', '재료명', '사용량', '단위', '사용 단가', '재료 수량', '재료 단위', '재료 가격', '재료 단가']];
  appData.recipes.forEach(recipe => {
    let totalCost = 0;
    recipe.categories.forEach(cat => {
      cat.ingredients.forEach(ing => {
        totalCost += parseFloat(ing.usagePrice || 0);
        recipeRows.push([
          recipe.name,
          recipe.price,
          '', '', // 총원가, 원가율 나중에 채움
          cat.categoryName,
          cat.categoryCount,
          cat.subtotal,
          ing.name,
          ing.usage,
          ing.unit,
          ing.usagePrice,
          ing.ingredientQty,
          ing.ingredientUnit,
          ing.ingredientPrice,
          ing.ingredientUnitPrice
        ]);
      });
    });
    const firstRow = recipeRows.find(row => row[0] === recipe.name);
    if (firstRow) {
      firstRow[2] = totalCost.toFixed(2);
      firstRow[3] = recipe.price > 0 ? ((totalCost / recipe.price) * 100).toFixed(2) + '%' : '0%';
    }
  });
  const recipeSheet = XLSX.utils.aoa_to_sheet(recipeRows);
  XLSX.utils.book_append_sheet(wb, recipeSheet, 'Recipes');

  // 단위 시트
  const unitRows = [['단위']];
  appData.units.forEach(unit => unitRows.push([unit]));
  const unitSheet = XLSX.utils.aoa_to_sheet(unitRows);
  XLSX.utils.book_append_sheet(wb, unitSheet, 'Units');

  // ✅ 파일 저장 (모바일 대응)
  const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
  const blob = new Blob([wbout], {
    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
  });

  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = '전체_데이터_백업.xlsx';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  // 화면 전환
  document.getElementById('app').classList.add('hidden');
  document.getElementById('loginScreen').style.display = 'flex';

  location.reload(); // 페이지 새로고침
}


  
  
    function showSection(id) {
      document.querySelectorAll('.section').forEach(sec => sec.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      
  if (id === 'ingredientSection') {
    updateIngredientUnitOptions(); // ✅ 재료 메뉴 열릴 때 단위 목록 업데이트
  }
}
    // showSection('prepSection'); // 기본 표시 제거
    
function addUnit() {
  const input = document.getElementById('unitInput');
  const unit = input.value.trim();
  if (!unit) return;
  const ul = document.getElementById('unitItems');
  const existingUnits = Array.from(ul.children).map(li => li.firstChild.textContent.trim());
  if (existingUnits.includes(unit)) {
    alert('이미 등록된 단위입니다.');
    input.value = '';
    return;
  }
  const li = document.createElement('li');
  const span = document.createElement('span');
  span.textContent = unit;
  li.appendChild(span);
  const delBtn = document.createElement('button');
  delBtn.textContent = '삭제';
  delBtn.style.marginLeft = '10px';
  delBtn.onclick = () => {
    li.remove();
    const index = appData.units.indexOf(unit);
    if (index > -1) appData.units.splice(index, 1);
  };
  li.appendChild(delBtn);
  ul.appendChild(li);
  //  🔥  appData.units에 추가
  appData.units.push(unit);
  // 레시피 폼 내의 모든 단위 선택 요소 업데이트
  const recipeForms = document.getElementById('recipeForms');
  const selectElements = recipeForms.querySelectorAll('.recipe-ingredient select');
  selectElements.forEach(select => {
    updateRecipeIngredientUnitOptions(select); // 위에서 정의한 함수 재사용
  });
  input.value = '';
}


function addIngredientItem() {
  const category = document.getElementById('newIngredientCategory').value.trim();
  const name = document.getElementById('newIngredientName').value.trim();
  const quantity = parseFloat(document.getElementById('newIngredientQuantity').value);
  const unit = document.getElementById('newIngredientUnit').value.trim();
  const price = parseFloat(document.getElementById('newIngredientPrice').value);

  if (!category || !name) {
    alert('분류, 재료명을 입력해주세요.');
    return;
  }
  
  

  const unitPrice = quantity > 0 ? (price / quantity).toFixed(2) : '0';

  const tbody = document.getElementById('ingredientTable').querySelector('tbody');
  const tr = tbody.insertRow();

  tr.insertCell(0).textContent = category;
  tr.insertCell(1).textContent = name;
  tr.insertCell(2).textContent = quantity;
  tr.insertCell(3).textContent = unit;
  tr.insertCell(4).textContent = price.toLocaleString();
  tr.insertCell(5).textContent = unitPrice;

  const delCell = tr.insertCell(6);
  const btn = document.createElement('button');
  btn.textContent = '삭제';
  btn.onclick = () => tr.remove();
  delCell.appendChild(btn);

  // 입력창 초기화
  document.getElementById('newIngredientCategory').value = '';
  document.getElementById('newIngredientName').value = '';
  document.getElementById('newIngredientQuantity').value = '';
  document.getElementById('newIngredientUnit').value = '';
  document.getElementById('newIngredientPrice').value = '';
}

function updateIngredientUnitOptions() {
  const select = document.getElementById('newIngredientUnit');
  select.innerHTML = ''; // 초기화

  appData.units.forEach(unit => {
    const option = document.createElement('option');
    option.value = unit;
    option.textContent = unit;
    select.appendChild(option);
  });
}


function sortIngredients(column, direction) {
  const table = document.getElementById('ingredientTable');
  const tbody = table.querySelector('tbody');
  const rows = Array.from(tbody.rows);

  const columnIndexMap = {
    category: 0,
    name: 1,
    quantity: 2,
    unit: 3,
    price: 4,
    unitPrice: 5,
  };

  const index = columnIndexMap[column];
  const isAsc = direction === 'asc';

  rows.sort((a, b) => {
    const valA = a.cells[index].textContent.trim();
    const valB = b.cells[index].textContent.trim();

    const numA = parseFloat(valA.replace(/,/g, ''));
    const numB = parseFloat(valB.replace(/,/g, ''));

    const isNumber = !isNaN(numA) && !isNaN(numB);
    if (isNumber) {
      return isAsc ? numA - numB : numB - numA;
    } else {
      return isAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
    }
  });

  rows.forEach(row => tbody.appendChild(row));
}

    document.getElementById('addPrepBtn').addEventListener('click', () => {
      const table = document.getElementById('prepTable').getElementsByTagName('tbody')[0];
      const dish = document.getElementById('prepDish').value;
      const name = document.getElementById('prepName').value;
      const ingredient = document.getElementById('prepIngredient').value;
      if (!dish || !name) {
        alert('요리명과 프랩 내용을 입력해주세요.');
        return;
      }
      const row = table.insertRow();
      row.insertCell(0).textContent = dish;
      row.insertCell(1).innerHTML = name.replace(/\n/g, '<br>');
      row.insertCell(2).innerHTML = ingredient.replace(/\n/g, '<br>');
      const deleteCell = row.insertCell(3);
      const delBtn = document.createElement('button');
      delBtn.textContent = '삭제';
      delBtn.onclick = () => row.remove();
      deleteCell.appendChild(delBtn);
      document.getElementById('prepDish').value = '';
      document.getElementById('prepName').value = '';
      document.getElementById('prepIngredient').value = '';
    });

    function clearPrepList() {
      const table = document.getElementById('prepTable').getElementsByTagName('tbody')[0];
      table.innerHTML = '';
    }
    
//여기서 부터 레시피 함수
function showAddRecipeForm() {
    document.getElementById("addRecipeForm").classList.remove("hidden");
  }

  function hideAddRecipeForm() {
  document.getElementById("addRecipeForm").classList.add("hidden");
  editingRecipeIndex = null; // ✅ 편집 인덱스 초기화
}
  
  function addRecipeCategory() {
  const container = document.getElementById('recipeForms');

  const wrapper = document.createElement('div');
  wrapper.classList.add('recipe-category-block');
  wrapper.style.borderTop = '1px solid #ddd';
  wrapper.style.paddingTop = '20px';
  wrapper.style.marginTop = '20px';

  wrapper.innerHTML = `
    <input type="text" placeholder="분류명" class="category-name" />

    <div style="margin-top: 10px;">소계: <span class="category-subtotal">0 원</span></div>
    <input type="number" class="category-count" placeholder="소계 수량" style="margin: 5px 0; width: 100%;" />

    <button onclick="calculateCategorySubtotal(this)" class="action-btn">계산</button>
    <button onclick="addIngredientToCategory(this)" class="action-btn">재료추가</button>

    <div style="border-top: 1px solid #ddd; margin: 10px 0;"></div>

    <div class="ingredient-list" style="margin-top: 10px;"></div>
    
    <button onclick="removeCategoryBlock(this)" class="action-btn">분류 삭제</button>
  `;

  container.appendChild(wrapper);
}


function removeCategoryBlock(button) {
  const categoryDiv = button.closest('.recipe-category-block');
  categoryDiv.remove();
}

function addIngredientToCategory(button) {
  const ingredientList = button.closest('.recipe-category-block').querySelector('.ingredient-list');
  const wrapper = document.createElement('div');
  wrapper.classList.add('ingredient-entry');
  wrapper.style.padding = '10px';
  wrapper.style.border = '1px solid #ddd';
  wrapper.style.borderRadius = '8px';
  wrapper.style.marginBottom = '10px';
  wrapper.style.background = '#f9f9f9';

  // ▶ 입력 요소 생성
  const inputName = document.createElement('input');
  inputName.placeholder = '재료명';
  const inputUsage = document.createElement('input');
  inputUsage.type = 'number';
  inputUsage.placeholder = '사용량';
  const selectUnit = document.createElement('select');
  getRegisteredUnits().forEach(unit => {
    const opt = document.createElement('option');
    opt.value = opt.textContent = unit;
    selectUnit.appendChild(opt);
  });
  const inputUsagePrice = document.createElement('input');
  inputUsagePrice.placeholder = '사용 단가';
  inputUsagePrice.readOnly = true;

  const inputIngredientQty = document.createElement('input');
  inputIngredientQty.placeholder = '재료 수량';
  inputIngredientQty.readOnly = true;

  const inputIngredientUnit = document.createElement('input');
  inputIngredientUnit.placeholder = '재료 단위';
  inputIngredientUnit.readOnly = true;

  const inputIngredientPrice = document.createElement('input');
  inputIngredientPrice.placeholder = '재료 가격';
  inputIngredientPrice.readOnly = true;

  const inputIngredientUnitPrice = document.createElement('input');
  inputIngredientUnitPrice.placeholder = '재료 단가';
  inputIngredientUnitPrice.readOnly = true;


  // ▶ 삭제 버튼
  const delBtn = document.createElement('button');
  delBtn.textContent = '삭제';
  delBtn.classList.add('action-btn');
  delBtn.onclick = () => wrapper.remove();

  // ▶ UI 구성
  const row1 = document.createElement('div');
  row1.style.display = 'flex';
  row1.style.gap = '8px';
  row1.style.flexWrap = 'wrap';
  row1.append(inputName, inputUsage, selectUnit, inputUsagePrice);

  const row2 = document.createElement('div');
  row2.style.display = 'flex';
  row2.style.gap = '8px';
  row2.style.flexWrap = 'wrap';
  row2.append(inputIngredientQty, inputIngredientUnit, inputIngredientPrice, inputIngredientUnitPrice);

  const bottom = document.createElement('div');
  bottom.style.marginTop = '10px';
  bottom.appendChild(delBtn);

  wrapper.append(row1, row2, bottom);
  ingredientList.prepend(wrapper);  // 버튼 바로 아래에 추가

  // ▶ 자동 채움 - 재료명 기준
  inputName.addEventListener('change', () => {
    const data = getIngredientDataByName(inputName.value);
    if (data) {
      inputIngredientQty.value = data.quantity;
      inputIngredientUnit.value = data.unit;
      inputIngredientPrice.value = data.price;
      inputIngredientUnitPrice.value = data.unitPrice;
      // 사용 단가도 재계산
      const usage = parseFloat(inputUsage.value) || 0;
      inputUsagePrice.value = (usage * data.unitPrice).toFixed(2);
    }
  });

  // ▶ 사용량 변경 시 사용 단가 계산 및 총 원가/원가율 업데이트
  inputUsage.addEventListener('input', () => {
    const usage = parseFloat(inputUsage.value) || 0;
    const unitPrice = parseFloat(inputIngredientUnitPrice.value) || 0;
    inputUsagePrice.value = (usage * unitPrice).toFixed(2);
    calculateCategorySubtotal(button);  //  ✅  소계, 총 원가, 원가율 재계산
  });
}


function calculateCategorySubtotal(button) {
  const block = button.closest('.recipe-category-block');
  const rows = block.querySelectorAll('.ingredient-row');

  let total = 0;
  let count = 0;

  rows.forEach(row => {
    const qty = parseFloat(row.querySelectorAll('input')[1].value) || 0;
    const price = parseFloat(row.querySelectorAll('input')[2].value) || 0;
    total += qty * price;
    count += 1;
  });

  block.querySelector('.category-subtotal').textContent = `${total.toLocaleString()} 원`;
  block.querySelector('.category-count').textContent = count;
}

function getRegisteredUnits() {
  return Array.from(document.querySelectorAll('#unitItems li span')).map(span => span.textContent);
}

function getIngredientDataByName(name) {
  const rows = document.querySelectorAll('#ingredientTable tbody tr');
  for (const row of rows) {
    const itemName = row.cells[1]?.textContent.trim();
    if (itemName === name.trim()) {
      return {
        quantity: parseFloat(row.cells[2]?.textContent) || 0,
        unit: row.cells[3]?.textContent.trim(),
        price: parseFloat(row.cells[4]?.textContent.replace(/,/g, '')) || 0,
        unitPrice: parseFloat(row.cells[5]?.textContent.replace(/,/g, '')) || 0,
      };
    }
  }
  return null;
}

function calculateTotalCostAndRate() {
  const categoryBlocks = document.querySelectorAll('.recipe-category-block');
  let totalCost = 0;
  categoryBlocks.forEach(block => {
    const subtotalText = block.querySelector('.category-subtotal')?.textContent || '0';
    const subtotal = parseFloat(subtotalText.replace(/[^\d.]/g, '')) || 0;
    totalCost += subtotal;
  });
  const sellingPrice = parseFloat(document.getElementById('sellingPrice')?.value) || 0;
  const costRate = (sellingPrice > 0)
    ? ((totalCost / sellingPrice) * 100).toFixed(2)
    : '0.00';
  document.getElementById('recipeTotalPrice').textContent = `총 원가: ${totalCost.toFixed(2)}원`;
  document.getElementById('costRate').textContent = `원가율: ${costRate}%`;
}



function calculateCategorySubtotal(button) {
  const block = button.closest('.recipe-category-block');
  const rows = block.querySelectorAll('.ingredient-entry');
  let totalUsagePrice = 0;
  let totalUsageAmount = 0;
  rows.forEach(entry => {
    const usage = parseFloat(entry.querySelector('input[placeholder="사용량"]')?.value) || 0;
    const usagePrice = parseFloat(entry.querySelector('input[placeholder="사용 단가"]')?.value) || 0;
    totalUsageAmount += usage;
    totalUsagePrice += usagePrice;
  });
  const categoryCountInput = block.querySelector('.category-count');
  const categoryCount = parseFloat(categoryCountInput?.value);
  let finalSubtotal = totalUsagePrice;
  if (!isNaN(categoryCount) && categoryCount > 0 && totalUsageAmount > 0) {
    finalSubtotal = totalUsagePrice / (totalUsageAmount / categoryCount);
  }
  //  ✅  소수점 둘째 자리까지 표시
  block.querySelector('.category-subtotal').textContent = `${finalSubtotal.toFixed(2)} 원`;
  calculateTotalCostAndRate(); //  ✅  총 원가 및 원가율 재계산
}

function addRecipe() {
  const name = document.getElementById('newRecipeName').value.trim();
  const price = parseFloat(document.getElementById('sellingPrice').value) || 0;
  const plating = document.getElementById('platingSteps').value;
  const memo = document.getElementById('recipeMemo').value;

  if (!name) {
    alert("레시피 이름을 입력하세요.");
    return;
  }

  const recipe = {
    name,
    price,
    plating,
    memo,
    categories: [],
  };

  document.querySelectorAll('.recipe-category-block').forEach(block => {
    const categoryName = block.querySelector('.category-name').value;
    const categoryCount = block.querySelector('.category-count').value;
    const subtotal = block.querySelector('.category-subtotal').textContent;

    const ingredients = [];

    block.querySelectorAll('.ingredient-entry').forEach(entry => {
      ingredients.push({
        name: entry.querySelector('input[placeholder="재료명"]').value,
        usage: entry.querySelector('input[placeholder="사용량"]').value,
        unit: entry.querySelector('select').value,
        usagePrice: entry.querySelector('input[placeholder="사용 단가"]').value,
        ingredientQty: entry.querySelector('input[placeholder="재료 수량"]').value,
        ingredientUnit: entry.querySelector('input[placeholder="재료 단위"]').value,
        ingredientPrice: entry.querySelector('input[placeholder="재료 가격"]').value,
        ingredientUnitPrice: entry.querySelector('input[placeholder="재료 단가"]').value,
      });
    });

    recipe.categories.push({ categoryName, categoryCount, subtotal, ingredients });
  });

  // 수정 또는 추가
  if (editingRecipeIndex !== null) {
    appData.recipes[editingRecipeIndex] = recipe;
    editingRecipeIndex = null;
  } else {
    appData.recipes.push(recipe);
  }

  renderRecipeList();
  hideAddRecipeForm();
  calculateTotalCostAndRate(); // 원가율 업데이트
}



function renderRecipeList() {
  const container = document.getElementById('recipeList');
  container.innerHTML = '';

  appData.recipes.forEach((recipe, index) => {
    const div = document.createElement('div');
    div.style.marginBottom = '10px';
    div.innerHTML = `
      <strong>${recipe.name}</strong> 
      <button onclick="loadRecipe(${index})">불러오기</button> 
      <button onclick="exportSingleRecipe(${index})">내보내기</button>
      <button onclick="deleteRecipe(${index})">삭제</button> <!-- ✅ 삭제 버튼 추가 -->
    `;
    container.appendChild(div);
  });
}



function loadRecipe(index) {
  const recipe = appData.recipes[index];
  editingRecipeIndex = index; // ✅ 현재 편집 중인 레시피 인덱스 저장
  showAddRecipeForm();

  document.getElementById('newRecipeName').value = recipe.name;
  document.getElementById('sellingPrice').value = recipe.price;
  document.getElementById('platingSteps').value = recipe.plating;
  document.getElementById('recipeMemo').value = recipe.memo;

  const container = document.getElementById('recipeForms');
  container.innerHTML = '';
  recipe.categories.forEach(cat => {
    addRecipeCategory();
    const lastBlock = container.lastChild;
    lastBlock.querySelector('.category-name').value = cat.categoryName;
    lastBlock.querySelector('.category-count').value = cat.categoryCount;
    lastBlock.querySelector('.category-subtotal').textContent = cat.subtotal;

    const ingList = lastBlock.querySelector('.ingredient-list');
    cat.ingredients.forEach(ing => {
      addIngredientToCategory(lastBlock.querySelector('button'));
      const lastEntry = ingList.firstChild;
      lastEntry.querySelector('input[placeholder="재료명"]').value = ing.name;
lastEntry.querySelector('input[placeholder="사용량"]').value = ing.usage;
lastEntry.querySelector('select').value = ing.unit;
lastEntry.querySelector('input[placeholder="사용 단가"]').value = ing.usagePrice;
lastEntry.querySelector('input[placeholder="재료 수량"]').value = ing.ingredientQty;
lastEntry.querySelector('input[placeholder="재료 단위"]').value = ing.ingredientUnit;
lastEntry.querySelector('input[placeholder="재료 가격"]').value = ing.ingredientPrice;
lastEntry.querySelector('input[placeholder="재료 단가"]').value = ing.ingredientUnitPrice;
    });
  });
}


function exportSingleRecipe(index) {
  const recipe = appData.recipes[index];
  const wb = XLSX.utils.book_new();
  const rows = [];

  rows.push(['레시피명', recipe.name]);
  rows.push(['판매가', recipe.price]);

  const totalCost = recipe.categories.reduce((sum, cat) => {
    return sum + parseFloat(cat.subtotal.replace(/[^\d.]/g, '') || 0);
  }, 0);

  const costRate = recipe.price > 0 ? ((totalCost / recipe.price) * 100).toFixed(2) + '%' : '0%';
  rows.push(['총 원가', totalCost.toFixed(2)]);
  rows.push(['원가율', costRate]);
  rows.push([]);

  rows.push([
    '분류명', '재료명', '사용량', '단위', '사용 단가',
    '재료 수량', '재료 단위', '재료 가격', '재료 단가'
  ]);

  recipe.categories.forEach(cat => {
    cat.ingredients.forEach(ing => {
      rows.push([
        cat.categoryName || '',
        ing.name || '',
        ing.usage || '',
        ing.unit || '',
        ing.usagePrice || '',
        ing.ingredientQty || '',
        ing.ingredientUnit || '',
        ing.ingredientPrice || '',
        ing.ingredientUnitPrice || ''
      ]);
    });
  });

  const ws = XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, '레시피');

  const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
  const blob = new Blob([wbout], {
    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
  });

  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${recipe.name}_레시피.xlsx`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}







//여기까지 레시피 함수


    function exportIngredientToExcel() {
  const table = document.getElementById('ingredientTable');
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.table_to_sheet(table);
  XLSX.utils.book_append_sheet(wb, ws, 'Ingredients');

  const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
  const blob = new Blob([wbout], {
    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
  });

  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'ingredient_list.xlsx';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}


    function exportPrepToExcel() {
  const table = document.getElementById('prepTable');
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.table_to_sheet(table);
  XLSX.utils.book_append_sheet(wb, ws, 'PrepList');

  const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
  const blob = new Blob([wbout], {
    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
  });

  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'prep_list.xlsx';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}


function importIngredientFromExcel() {
  const fileInput = document.getElementById('importIngredientExcel');
  const file = fileInput.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function (e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    const tbody = document.getElementById('ingredientTable').querySelector('tbody');

    // ✅ 중복 체크용 Set 생성 (분류 + 이름)
    const existingSet = new Set();
    Array.from(tbody.rows).forEach(row => {
      const category = row.cells[0]?.textContent.trim();
      const name = row.cells[1]?.textContent.trim();
      existingSet.add(`${category}::${name}`);
    });

    for (let i = 1; i < rows.length; i++) {
      const row = rows[i];
      if (!row || row.length < 6) continue;

      const category = (row[0] || '').toString().trim();
      const name = (row[1] || '').toString().trim();
      const quantity = row[2];
      const unit = row[3];
      const price = row[4];
      const unitPrice = row[5];

      const key = `${category}::${name}`;
      if (existingSet.has(key)) continue; // ✅ 중복이면 추가하지 않음

      const tr = tbody.insertRow();
      tr.insertCell(0).textContent = category;
      tr.insertCell(1).textContent = name;
      tr.insertCell(2).textContent = quantity;
      tr.insertCell(3).textContent = unit;
      tr.insertCell(4).textContent = price;
      tr.insertCell(5).textContent = unitPrice;

      const delCell = tr.insertCell(6);
      const delBtn = document.createElement('button');
      delBtn.textContent = '삭제';
      delBtn.onclick = () => tr.remove();
      delCell.appendChild(delBtn);

      existingSet.add(key);
    }

    fileInput.value = ''; // 파일 초기화
  };

  reader.readAsArrayBuffer(file);
}

    function importPrepFromExcel() {
      const fileInput = document.getElementById('prepUploadFile');
      const file = fileInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        const tbody = document.getElementById('prepTable').getElementsByTagName('tbody')[0];
        const existingSet = new Set();
        for (const row of tbody.rows) {
          const dish = row.cells[0]?.textContent.trim();
          const prep = row.cells[1]?.textContent.trim().replace(/\s+/g, ' ');
          existingSet.add(`${dish}::${prep}`);
        }
        for (let i = 1; i < rows.length; i++) {
          const row = rows[i];
          if (!row || row.every(cell => !cell)) continue;
          const dish = (row[1] || '').toString().trim();
          const prep = (row[2] || '').toString().trim().replace(/\r?\n/g, '<br>');
          const ingredient = (row[3] || '').toString().trim();
          const key = `${dish}::${prep}`;
          if (existingSet.has(key)) continue;
          const tr = tbody.insertRow();
          tr.insertCell(0).textContent = dish;
          tr.insertCell(1).innerHTML = prep.replace(/\n/g, '<br>');
          tr.insertCell(2).innerHTML = ingredient.replace(/\n/g, '<br>');
          const delCell = tr.insertCell(3);
          const btn = document.createElement('button');
          btn.textContent = '삭제';
          btn.onclick = () => tr.remove();
          delCell.appendChild(btn);
          existingSet.add(key);
        }
        fileInput.value = '';
      };
      reader.readAsArrayBuffer(file);
    }

    function toggleUnitInput() {
      const inputArea = document.getElementById('unitInputArea');
      inputArea.style.display = inputArea.style.display === 'none' ? 'block' : 'none';
    }

    function addUnit() {
      const input = document.getElementById('unitInput');
      const unit = input.value.trim();
      if (!unit) return;
      const ul = document.getElementById('unitItems');
      const existingUnits = Array.from(ul.children).map(li => li.firstChild.textContent.trim());
      if (existingUnits.includes(unit)) {
        alert('이미 등록된 단위입니다.');
        input.value = '';
        return;
      }
      const li = document.createElement('li');
      const span = document.createElement('span');
      span.textContent = unit;
      li.appendChild(span);
      const delBtn = document.createElement('button');
      delBtn.textContent = '삭제';
      delBtn.style.marginLeft = '10px';
      delBtn.onclick = () => li.remove();
      li.appendChild(delBtn);
      ul.appendChild(li);
      input.value = '';
    }
  </script>
</body>
</html>



